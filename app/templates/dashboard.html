.input{background:#0f172a;border:1px solid var(--line);color:var(--fg);border-radius:8px;padding:6px 8px;width:90px}
.toast{position:fixed;right:16px;bottom:16px;background:#0c111b;border:1px solid #223049;color:#e8eaf0;padding:10px 12px;border-radius:10px;opacity:0;transform:translateY(8px);transition:all .2s}
.toast.show{opacity:1;transform:translateY(0)}
    /* signals */
    /* signals table helpers */
.ok{color:var(--pos);font-weight:600}
.bad{color:var(--neg);font-weight:600}
.warn{color:var(--warn);font-weight:600}
.chip{padding:.1rem .35rem;border-radius:.35rem;background:#111827;border:1px solid #1f2937}
details summary{cursor:pointer;list-style:none}
details summary::-webkit-details-marker{display:none}
.mono{font-variant-numeric:tabular-nums}
    /* KPI şeridi */
    .kpis{display:grid;gap:10px;grid-template-columns:repeat(5,1fr);margin-bottom:16px}
    .kpi{background:#0e1420;border:1px solid var(--line);border-radius:12px;padding:12px}
    .kpi .label{color:var(--muted);font-size:12px;margin-bottom:6px}
    .kpi .value{font-size:22px;font-weight:700}
    @media(max-width:900px){.kpis{grid-template-columns:repeat(2,1fr)}}
</style>
</head>
<body>
@@ -50,6 +56,30 @@ <h1>Scalper Dashboard</h1>
<div class="badge"><span id="symbolsBadge">SYMBOLS</span> · <span id="streamBadge">STREAM</span> · <span id="clock"></span></div>
</div>

  <!-- KPI BAR: toplam long/short, win/loss, winrate -->
  <div class="kpis">
    <div class="kpi">
      <div class="label">Toplam Long (kapandı)</div>
      <div class="value" id="kpiLong">0</div>
    </div>
    <div class="kpi">
      <div class="label">Toplam Short (kapandı)</div>
      <div class="value" id="kpiShort">0</div>
    </div>
    <div class="kpi">
      <div class="label">Kârla Kapanan (Win)</div>
      <div class="value ok" id="kpiWins">0</div>
    </div>
    <div class="kpi">
      <div class="label">Zararla Kapanan (Loss)</div>
      <div class="value bad" id="kpiLosses">0</div>
    </div>
    <div class="kpi">
      <div class="label">Win Rate</div>
      <div class="value" id="kpiWinRate">0%</div>
    </div>
  </div>

<!-- Manuel Trade Paneli -->
<div class="card">
<h2>Manual Trade</h2>
@@ -76,7 +106,7 @@ <h2>Manual Trade</h2>
</div>
</div>

  <!-- Open Positions (full width) -->
  <!-- Open Positions -->
<div class="card">
<h2>Open Positions</h2>
<table id="posTable">
@@ -106,17 +136,11 @@ <h2>Open Positions</h2>
<div class="hint" style="margin-top:8px">PnL $ = (Price-Entry)×Qty (long) / (Entry-Price)×Qty (short). Notional = Entry×Qty.</div>
</div>

  <!-- Signals (live) now UNDER positions (full width) -->
  <!-- Signals (live) -->
<div class="card">
<h2>Signals (live)</h2>
<div class="hint" style="margin-bottom:8px">
      Filtre eşikleri —
      Tick/s ≥ <b>{{ thresholds.MIN_TICKS_PER_SEC|default(1.0) }}</b>,
      Spread bps ≤ <b>{{ thresholds.MAX_SPREAD_BPS|default(5) }}</b>,
      BuyPress ≥ <b>{{ thresholds.BUY_PRESSURE_MIN|default(0.55) }}</b>,
      Imbalance ≥ <b>{{ thresholds.IMB_THRESHOLD|default(0.9) }}</b>,
      ATR ∈ [<b>{{ thresholds.ATR_MIN|default(0.0002) }}</b>, <b>{{ thresholds.ATR_MAX|default(0.05) }}</b>],
      VWAP sapma ≤ <b>0.20%</b>.
      Filtre eşikleri — Tick/s ≥ 2.0, Spread bps ≤ 5, BuyPress ≥ 0.55, Imbalance ≥ 0.9, ATR ∈ [0.0002, 0.05], VWAP sapma ≤ 0.20%.
</div>
<div class="table-responsive">
<table class="table-compact" style="width:100%">
@@ -128,8 +152,8 @@ <h2>Signals (live)</h2>
<th class="num">EMAf</th>
<th class="num">EMAs</th>
<th class="num">RSI14</th>
            <th class="num">VWAP ({{ thresholds.VWAP_WINDOW_SEC|default(60) }}s)</th>
            <th class="num">ATR ({{ thresholds.ATR_WINDOW_SEC|default(60) }}s)</th>
            <th class="num">VWAP (60s)</th>
            <th class="num">ATR (60s)</th>
<th class="num">Tick/s</th>
<th class="num">Spread bps</th>
<th class="num">BuyPress</th>
@@ -148,7 +172,7 @@ <h2>Signals (live)</h2>
</details>
</div>

  <!-- History (full width) -->
  <!-- History -->
<div class="card">
<div style="display:flex;justify-content:space-between;align-items:center">
<h2>History (Last 100)</h2>
@@ -195,18 +219,6 @@ <h2>History (Last 100)</h2>
};
const clsP = v => (v||0) >= 0 ? 'pnl-pos' : 'pnl-neg';

  // thresholdlar
  const TH = {
    MIN_TICKS_PER_SEC: {{ thresholds.MIN_TICKS_PER_SEC|default(1.0) }},
    MAX_SPREAD_BPS: {{ thresholds.MAX_SPREAD_BPS|default(5) }},
    BUY_PRESSURE_MIN: {{ thresholds.BUY_PRESSURE_MIN|default(0.55) }},
    IMB_THRESHOLD: {{ thresholds.IMB_THRESHOLD|default(0.9) }},
    ATR_MIN: {{ thresholds.ATR_MIN|default(0.0002) }},
    ATR_MAX: {{ thresholds.ATR_MAX|default(0.05) }},
    VWAP_WINDOW_SEC: {{ thresholds.VWAP_WINDOW_SEC|default(60) }},
    ATR_WINDOW_SEC: {{ thresholds.ATR_WINDOW_SEC|default(60) }},
  };

// header badges
async function loadHealth(){
try{
@@ -260,12 +272,12 @@ <h2>History (Last 100)</h2>
}
}

  // signals
  // signals (tablo + ham json)
function decideSide(row){
const ef=row.ema_fast, es=row.ema_slow, bp=row.buy_pressure_2s, rsi=row.rsi14;
if([ef,es,bp].some(v=>v==null)) return null;
    if(ef>es && bp>=TH.BUY_PRESSURE_MIN && (rsi==null || rsi<70)) return 'long';
    if(ef<es && bp<=1-TH.BUY_PRESSURE_MIN && (rsi==null || rsi>30)) return 'short';
    if(ef>es && bp>=0.55 && (rsi==null || rsi<70)) return 'long';
    if(ef<es && bp<=0.45 && (rsi==null || rsi>30)) return 'short';
return null;
}
function cls(ok){ return ok ? 'ok' : 'bad'; }
@@ -280,7 +292,6 @@ <h2>History (Last 100)</h2>
document.getElementById('signalsBox').textContent = JSON.stringify(sigs,null,2);
}catch{ document.getElementById('signalsBox').textContent = 'Yüklenemedi.'; }
}

function renderSignalsTable(sigs){
const tb = document.getElementById('signalsTBody');
tb.innerHTML = '';
@@ -293,12 +304,12 @@ <h2>History (Last 100)</h2>
const vwapDev = (vwap && lp) ? Math.abs(lp - vwap)/vwap : null;

const pass = {
        tick: (s.tick_rate_2s??0) >= TH.MIN_TICKS_PER_SEC,
        spread: (s.spread_bps??Infinity) <= TH.MAX_SPREAD_BPS,
        atr: (s.atr60!=null) && s.atr60 >= TH.ATR_MIN && s.atr60 <= TH.ATR_MAX,
        tick: (s.tick_rate_2s??0) >= 2.0,
        spread: (s.spread_bps??Infinity) <= 5,
        atr: (s.atr60!=null) && s.atr60 >= 0.0002 && s.atr60 <= 0.05,
vwapDev: (vwapDev==null) ? false : (vwapDev <= 0.002),
        bp: (s.buy_pressure_2s!=null) && (s.buy_pressure_2s >= TH.BUY_PRESSURE_MIN),
        imb: (s.imbalance!=null) && (s.imbalance >= TH.IMB_THRESHOLD),
        bp: (s.buy_pressure_2s!=null) && (s.buy_pressure_2s >= 0.55),
        imb: (s.imbalance!=null) && (s.imbalance >= 0.9),
rsiCap: (s.rsi14==null) ? true : (s.rsi14 < 70)
};
const rulesOK = pass.tick && pass.spread && pass.atr && pass.vwapDev && pass.bp && pass.imb && pass.rsiCap;
@@ -323,37 +334,71 @@ <h2>History (Last 100)</h2>
}
}

  // history
  async function loadHistory(){
  // history + KPI özet
  async function loadHistory(limit=100){
const body = document.getElementById('histBody');
try{
      const r = await fetch('/history?limit=100',{cache:'no-store'}); const j = await r.json();
      const r = await fetch(`/history?limit=${limit}`,{cache:'no-store'}); const j = await r.json();
const rows = (j && j.ok && Array.isArray(j.rows)) ? j.rows : [];
      body.innerHTML = '';
      if(rows.length===0){ body.innerHTML = `<tr><td class="muted" colspan="12">Kayıt yok.</td></tr>`; return; }
      for(const x of rows){
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${x.symbol}</td>
          <td>${x.side}</td>
          <td class="num">${fmtQ(x.qty)}</td>
          <td class="num">${fmt4(x.entry)}</td>
          <td class="num">${fmt4(x.exit)}</td>
          <td class="num ${clsP(x.pnl)}">${fmt2(x.pnl)}</td>
          <td class="num">${x.leverage ?? '-'}</td>
          <td class="num">${fmt2(x.margin_usd)}</td>
          <td class="num">${fmt2(x.notional_usd)}</td>
          <td class="num">${fmt4(x.liq_price)}</td>
          <td class="num">${x.opened_at || '-'}</td>
          <td class="num">${x.closed_at || '-'}</td>
        `;
        body.appendChild(tr);
      // tablo
      if(limit===100){
        body.innerHTML = '';
        if(rows.length===0){ body.innerHTML = `<tr><td class="muted" colspan="12">Kayıt yok.</td></tr>`; }
        for(const x of rows){
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${x.symbol}</td>
            <td>${x.side}</td>
            <td class="num">${fmtQ(x.qty)}</td>
            <td class="num">${fmt4(x.entry)}</td>
            <td class="num">${fmt4(x.exit)}</td>
            <td class="num ${clsP(x.pnl)}">${fmt2(x.pnl)}</td>
            <td class="num">${x.leverage ?? '-'}</td>
            <td class="num">${fmt2(x.margin_usd)}</td>
            <td class="num">${fmt2(x.notional_usd)}</td>
            <td class="num">${fmt4(x.liq_price)}</td>
            <td class="num">${x.opened_at || '-'}</td>
            <td class="num">${x.closed_at || '-'}</td>
          `;
          body.appendChild(tr);
        }
}
      // KPI (daha geniş limit ile say)
      computeKPIs(rows);
}catch(e){
      body.innerHTML = `<tr><td class="muted" colspan="12">Yüklenemedi.</td></tr>`;
      if(limit===100) body.innerHTML = `<tr><td class="muted" colspan="12">Yüklenemedi.</td></tr>`;
      computeKPIs([]);
}
}

  async function loadSummary(){
    // kpi için daha büyük örneklem – istersen 10000 yapabilirsin
    const r = await fetch('/history?limit=1000',{cache:'no-store'});
    const j = await r.json();
    const rows = (j && j.ok && Array.isArray(j.rows)) ? j.rows : [];
    computeKPIs(rows);
  }

  function computeKPIs(rows){
    let longCnt=0, shortCnt=0, wins=0, losses=0;
    for(const x of rows){
      if(x.side==='long') longCnt++;
      else if(x.side==='short') shortCnt++;
      if(typeof x.pnl === 'number'){
        if(x.pnl>0) wins++;
        else if(x.pnl<0) losses++;
      }
    }
    const totalWL = wins+losses;
    const winRate = totalWL>0 ? (wins/totalWL*100).toFixed(1) : '0.0';

    document.getElementById('kpiLong').textContent = longCnt;
    document.getElementById('kpiShort').textContent = shortCnt;
    document.getElementById('kpiWins').textContent = wins;
    document.getElementById('kpiLosses').textContent = losses;
    document.getElementById('kpiWinRate').textContent = `${winRate}%`;
  }

// manuel trade butonları
function getLev(){ return Math.max(1, parseInt(document.getElementById('levInput').value || '10', 10)); }
function getMargin(){ return Math.max(1, parseFloat(document.getElementById('marginInput').value || '10')); }
@@ -367,7 +412,7 @@ <h2>History (Last 100)</h2>
const j = await r.json();
if(!r.ok || j.ok===false){ throw new Error(j.error || 'order_failed'); }
toast(`✅ ${symbol} ${side.toUpperCase()} opened (lev=${payload.leverage}, margin=$${payload.margin_usd})`);
      loadPositions(); loadHistory();
      loadPositions(); loadHistory(); loadSummary();
}catch(e){
toast(`❌ Order failed: ${e.message}`);
}
@@ -381,7 +426,7 @@ <h2>History (Last 100)</h2>
const j = await r.json();
if(!r.ok || j.ok===false){ throw new Error(j.error || 'close_failed'); }
toast(`ℹ️ ${symbol} closed. PnL=$${j.closed?.pnl?.toFixed?.(2) ?? j.closed?.pnl ?? ''}`);
      loadPositions(); loadHistory();
      loadPositions(); loadHistory(); loadSummary();
}catch(e){
toast(`❌ Close failed: ${e.message}`);
}
