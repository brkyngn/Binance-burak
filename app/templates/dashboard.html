<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Scalper Dashboard</title>
  <style>
    :root {
      --bg:#0f1115; --panel:#171a21; --fg:#e8eaf0; --muted:#9aa3b2;
      --pos:#17a34a; --neg:#ef4444; --thead:#212634; --line:#232838; --accent:#3b82f6;
    }
    html,body{background:var(--bg);color:var(--fg);margin:0;font:14px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:1280px;margin:24px auto;padding:0 16px}
    h1{font-size:28px;margin:0 0 10px}
    h2{font-size:18px;margin:0 0 12px}
    .row{display:grid;gap:18px}
    @media(min-width:1000px){.row{grid-template-columns:2fr 1fr}}
    @media(min-width:1200px){.row-3{grid-template-columns:2fr 1fr}}
    .card{background:var(--panel);border-radius:14px;padding:16px 16px 12px;box-shadow:0 8px 18px rgba(0,0,0,.25)}
    table{width:100%;border-collapse:collapse;border-radius:12px;overflow:hidden}
    thead th{background:var(--thead);color:var(--fg);font-weight:700;padding:10px;border-bottom:1px solid var(--line);text-align:left}
    tbody td{padding:10px;border-bottom:1px solid var(--line)}
    .num{text-align:right;font-variant-numeric:tabular-nums}
    .muted{color:var(--muted)}
    .pnl-pos{color:var(--pos);font-weight:700}
    .pnl-neg{color:var(--neg);font-weight:700}
    .side-long{color:var(--pos);font-weight:700}
    .side-short{color:#f59e0b;font-weight:700}
    pre{white-space:pre-wrap;word-break:break-word;background:#0c0f14;border:1px solid var(--line);padding:10px;border-radius:10px;max-height:420px;overflow:auto}
    .toolbar{display:flex;gap:10px;align-items:center;justify-content:space-between;margin:6px 0 14px}
    .badge{background:#0e1420;border:1px solid var(--line);padding:6px 10px;border-radius:999px}
    .hint{color:var(--muted);font-size:12px}
    .btn{background:#0f172a;border:1px solid var(--line);color:var(--fg);padding:6px 10px;border-radius:10px;cursor:pointer}
    .btn:hover{border-color:#364055}
    .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:8px}
    .input{background:#0f172a;border:1px solid var(--line);color:var(--fg);border-radius:8px;padding:6px 8px;width:90px}
    .toast{position:fixed;right:16px;bottom:16px;background:#0c111b;border:1px solid #223049;color:#e8eaf0;padding:10px 12px;border-radius:10px;opacity:0;transform:translateY(8px);transition:all .2s}
    .toast.show{opacity:1;transform:translateY(0)}
  </style>
</head>
<body>
<div class="wrap">
  <div class="toolbar">
    <h1>Scalper Dashboard</h1>
    <div class="badge"><span id="symbolsBadge">SYMBOLS</span> · <span id="streamBadge">STREAM</span> · <span id="clock"></span></div>
  </div>

  <!-- Manuel Trade Paneli -->
  <div class="card" style="margin-bottom:18px">
    <h2>Manual Trade</h2>
    <div class="controls">
      <label>Leverage
        <input id="levInput" class="input" type="number" value="10" min="1" step="1" />
      </label>
      <label>Margin $
        <input id="marginInput" class="input" type="number" value="10" min="1" step="1" />
      </label>
      <span class="hint">Qty verilmezse qty = (margin × lev) / price olarak sunucu tarafında hesaplanır.</span>
    </div>
    <div class="controls">
      <strong>BTCUSDT:</strong>
      <button class="btn" onclick="order('BTCUSDT','long')">Long</button>
      <button class="btn" onclick="order('BTCUSDT','short')">Short</button>
      <button class="btn" onclick="closePos('BTCUSDT')">Close</button>
    </div>
    <div class="controls">
      <strong>ETHUSDT:</strong>
      <button class="btn" onclick="order('ETHUSDT','long')">Long</button>
      <button class="btn" onclick="order('ETHUSDT','short')">Short</button>
      <button class="btn" onclick="closePos('ETHUSDT')">Close</button>
    </div>
  </div>

  <!-- ÜST SATIR: Positions + Signals -->
  <div class="row">
    <div class="card">
      <h2>Open Positions</h2>
      <table id="posTable">
        <thead>
          <tr>
            <th>Symbol</th>
            <th>Side</th>
            <th class="num">Qty</th>
            <th class="num">Entry</th>
            <th class="num">TP</th>
            <th class="num">SL</th>
            <th class="num">Entry $</th>
            <th class="num">TP $</th>
            <th class="num">SL $</th>
            <th class="num">PnL $</th>
            <th class="num">Lev.</th>
            <th class="num">Margin $</th>
            <th class="num">Notional $</th>
            <th class="num">Liq. Px</th>
            <th class="num">Opened At</th>
          </tr>
        </thead>
        <tbody id="posBody">
          <tr><td class="muted" colspan="15">Yükleniyor…</td></tr>
        </tbody>
      </table>
      <div class="hint" style="margin-top:8px">PnL $ = (Price-Entry)×Qty (long) / (Entry-Price)×Qty (short). Notional = Entry×Qty.</div>
    </div>

    <div class="card">
      <h2>Signals (raw)</h2>
      <pre id="signalsBox">Yükleniyor…</pre>
      <div class="hint">Anlık yön/filtre görünümü ham JSON olarak gösterilir.</div>
    </div>
  </div>

  <!-- ALT SATIR: History -->
  <div class="row-3" style="margin-top:18px">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h2>History (Last 100)</h2>
        <button class="btn" onclick="loadHistory()">Yenile</button>
      </div>
      <table id="histTable">
        <thead>
          <tr>
            <th>Symbol</th>
            <th>Side</th>
            <th class="num">Qty</th>
            <th class="num">Entry</th>
            <th class="num">Exit</th>
            <th class="num">PnL $</th>
            <th class="num">Lev.</th>
            <th class="num">Margin $</th>
            <th class="num">Notional $</th>
            <th class="num">Liq. Px</th>
            <th class="num">Opened</th>
            <th class="num">Closed</th>
          </tr>
        </thead>
        <tbody id="histBody">
          <tr><td class="muted" colspan="12">Yükleniyor…</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
  // ---------- format helpers ----------
  const nf2  = new Intl.NumberFormat('tr-TR',{minimumFractionDigits:2, maximumFractionDigits:2});
  const nf4  = new Intl.NumberFormat('tr-TR',{minimumFractionDigits:4, maximumFractionDigits:4});
  const nfQ  = new Intl.NumberFormat('tr-TR',{minimumFractionDigits:5, maximumFractionDigits:5});
  const fmt2 = x => (x==null||isNaN(x)) ? '-' : nf2.format(+x);
  const fmt4 = x => (x==null||isNaN(x)) ? '-' : nf4.format(+x);
  const fmtQ = x => (x==null||isNaN(x)) ? '-' : nfQ.format(+x);
  const fmtDate = ms => {
    if(!ms) return '-';
    const d = new Date(ms);
    return d.toLocaleString('tr-TR',{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',second:'2-digit'});
  };
  const clsP = v => (v||0) >= 0 ? 'pnl-pos' : 'pnl-neg';

  // ---------- header badges ----------
  async function loadHealth(){
    try{
      const r = await fetch('/healthz',{cache:'no-store'}); const j = await r.json();
      document.getElementById('symbolsBadge').textContent = (j.symbols||[]).join(', ');
      document.getElementById('streamBadge').textContent = j.stream || '';
    }catch{}
  }
  setInterval(()=>{document.getElementById('clock').textContent=new Date().toLocaleTimeString('tr-TR');},1000);

  // ---------- positions ----------
  async function loadPositions(){
    const body = document.getElementById('posBody');
    try{
      const res = await fetch('/paper/positions',{cache:'no-store'}); const data = await res.json();
      const open = (data && data.open) ? data.open : {};
      body.innerHTML = '';
      const keys = Object.keys(open);
      if(keys.length===0){ body.innerHTML = `<tr><td class="muted" colspan="15">Açık pozisyon yok.</td></tr>`; return; }

      for(const sym of keys){
        const p = open[sym]||{};
        const sideCls = p.side==='long' ? 'side-long':'side-short';

        const entryUsd = (p.notional_usd!=null) ? p.notional_usd : (p.qty&&p.entry ? p.qty*p.entry : null);
        const tpUsd = (p.tp&&p.qty) ? ((p.side==='long'?(p.tp-p.entry):(p.entry-p.tp))*p.qty + entryUsd) : null;
        const slUsd = (p.stop&&p.qty) ? ((p.side==='long'?(p.stop-p.entry):(p.entry-p.stop))*p.qty + entryUsd) : null;

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${sym}</td>
          <td class="${sideCls}">${p.side||'-'}</td>
          <td class="num">${fmtQ(p.qty)}</td>
          <td class="num">${fmt4(p.entry)}</td>
          <td class="num">${fmt4(p.tp)}</td>
          <td class="num">${fmt4(p.stop)}</td>
          <td class="num">${fmt2(entryUsd)}</td>
          <td class="num">${fmt2(tpUsd)}</td>
          <td class="num">${fmt2(slUsd)}</td>
          <td class="num ${clsP(p.pnl)}">${fmt2(p.pnl)}</td>
          <td class="num">${p.leverage ?? 1}</td>
          <td class="num">${fmt2(p.margin_usd)}</td>
          <td class="num">${fmt2(p.notional_usd)}</td>
          <td class="num">${fmt4(p.liq_price)}</td>
          <td class="num">${fmtDate(p.open_ts)}</td>
        `;
        body.appendChild(tr);
      }
    }catch(e){
      body.innerHTML = `<tr><td class="muted" colspan="15">Yüklenemedi.</td></tr>`;
    }
  }

  // ---------- signals ----------
  async function loadSignals(){
    try{
      const r = await fetch('/signals',{cache:'no-store'}); const j = await r.json();
      document.getElementById('signalsBox').textContent = JSON.stringify(j,null,2);
    }catch{ document.getElementById('signalsBox').textContent = 'Yüklenemedi.'; }
  }

  // ---------- history ----------
  async function loadHistory(){
    const body = document.getElementById('histBody');
    try{
      const r = await fetch('/history?limit=100',{cache:'no-store'}); const j = await r.json();
      const rows = (j && j.ok && Array.isArray(j.rows)) ? j.rows : [];
      body.innerHTML = '';
      if(rows.length===0){ body.innerHTML = `<tr><td class="muted" colspan="12">Kayıt yok.</td></tr>`; return; }
      for(const x of rows){
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${x.symbol}</td>
          <td>${x.side}</td>
          <td class="num">${fmtQ(x.qty)}</td>
          <td class="num">${fmt4(x.entry)}</td>
          <td class="num">${fmt4(x.exit)}</td>
          <td class="num ${clsP(x.pnl)}">${fmt2(x.pnl)}</td>
          <td class="num">${x.leverage ?? '-'}</td>
          <td class="num">${fmt2(x.margin_usd)}</td>
          <td class="num">${fmt2(x.notional_usd)}</td>
          <td class="num">${fmt4(x.liq_price)}</td>
          <td class="num">${x.opened_at || '-'}</td>
          <td class="num">${x.closed_at || '-'}</td>
        `;
        body.appendChild(tr);
      }
    }catch(e){
      body.innerHTML = `<tr><td class="muted" colspan="12">Yüklenemedi.</td></tr>`;
    }
  }

  // ---------- manuel trade butonları ----------
  function getLev(){ return Math.max(1, parseInt(document.getElementById('levInput').value || '10', 10)); }
  function getMargin(){ return Math.max(1, parseFloat(document.getElementById('marginInput').value || '10')); }

  async function order(symbol, side){
    try{
      const payload = { symbol, side, leverage: getLev(), margin_usd: getMargin() };
      const r = await fetch('/paper/order', {
        method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)
      });
      const j = await r.json();
      if(!r.ok || j.ok===false){ throw new Error(j.error || 'order_failed'); }
      toast(`✅ ${symbol} ${side.toUpperCase()} opened (lev=${payload.leverage}, margin=$${payload.margin_usd})`);
      loadPositions(); loadHistory();
    }catch(e){
      toast(`❌ Order failed: ${e.message}`);
    }
  }

  async function closePos(symbol){
    try{
      const r = await fetch('/paper/close', {
        method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({symbol})
      });
      const j = await r.json();
      if(!r.ok || j.ok===false){ throw new Error(j.error || 'close_failed'); }
      toast(`ℹ️ ${symbol} closed. PnL=$${j.closed?.pnl?.toFixed?.(2) ?? j.closed?.pnl ?? ''}`);
      loadPositions(); loadHistory();
    }catch(e){
      toast(`❌ Close failed: ${e.message}`);
    }
  }

  // ---------- küçük toast ----------
  function toast(msg){
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(()=>t.classList.remove('show'), 2500);
  }

  // ---------- kick ----------
  loadHealth();
  loadPositions(); loadSignals(); loadHistory();
  setInterval(loadPositions, 2000);
  setInterval(loadSignals, 4000);
  setInterval(loadHistory, 10000);
</script>
</body>
</html>
