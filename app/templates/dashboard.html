<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Scalper Dashboard</title>
  <style>
    :root {
      --bg: #0f1115; --panel: #171a21; --fg: #e8eaf0; --muted:#9aa3b2;
      --pos:#17a34a; --neg:#ef4444; --thead:#212634; --line:#232838;
    }
    html,body {background:var(--bg); color:var(--fg); margin:0; font: 14px/1.4 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;}
    .wrap {max-width: 1280px; margin: 24px auto; padding: 0 16px;}
    h1 {font-size: 34px; margin: 0 0 16px 0;}
    .card {background: var(--panel); border-radius: 14px; padding: 18px; box-shadow: 0 10px 18px rgba(0,0,0,.2);}
    table {width:100%; border-collapse: collapse; overflow: hidden; border-radius: 12px;}
    thead th {background: var(--thead); color: var(--fg); font-weight: 700; padding: 12px; border-bottom: 1px solid var(--line); text-align: left;}
    tbody td {padding: 12px; border-bottom: 1px solid var(--line);}
    .num {text-align: right; font-variant-numeric: tabular-nums;}
    .muted {color: var(--muted);}
    .pnl-pos {color: var(--pos); font-weight: 700;}
    .pnl-neg {color: var(--neg); font-weight: 700;}
    .pair {letter-spacing: .3px; font-weight: 600;}
    .side-long {color: var(--pos); font-weight: 700;}
    .side-short {color: #f59e0b; font-weight: 700;}
    .grid {display:grid; gap: 18px;}
    @media (min-width: 900px){ .grid {grid-template-columns: 1fr;} }
  </style>
</head>

<body>
<div class="wrap">
  <h1>Open Positions</h1>

  <div class="grid">
    <div class="card">
      <table id="posTable">
        <thead>
        <tr>
          <th>Symbol</th>
          <th>Side</th>
          <th class="num">Qty</th>
          <th class="num">Entry</th>
          <th class="num">TP</th>
          <th class="num">SL</th>
          <th class="num">Entry $</th>
          <th class="num">TP $</th>
          <th class="num">SL $</th>
          <th class="num">PnL $</th>
          <th class="num">Lev.</th>
          <th class="num">Margin $</th>
          <th class="num">Notional $</th>
          <th class="num">Liq. Px</th>
          <th class="num">Opened At</th>
        </tr>
        </thead>
        <tbody id="posBody">
        <tr><td class="muted" colspan="15">Yükleniyor…</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
  // ----- format helpers (TR yerelleştirme) -----
  const nf2 = new Intl.NumberFormat('tr-TR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
  const nf4 = new Intl.NumberFormat('tr-TR', {minimumFractionDigits: 4, maximumFractionDigits: 4});
  const nfQty = new Intl.NumberFormat('tr-TR', {minimumFractionDigits: 5, maximumFractionDigits: 5});

  const fmt2 = x => (x == null || isNaN(x)) ? '-' : nf2.format(+x);
  const fmt4 = x => (x == null || isNaN(x)) ? '-' : nf4.format(+x);
  const fmtQty = x => (x == null || isNaN(x)) ? '-' : nfQty.format(+x);
  const fmtDate = ms => {
    if (!ms) return '-';
    try {
      const d = new Date(ms);
      return d.toLocaleString('tr-TR', {
        year:'2-digit', month:'2-digit', day:'2-digit',
        hour:'2-digit', minute:'2-digit', second:'2-digit'
      });
    } catch { return '-'; }
  };

  function clsPnl(v){ return (v||0) >= 0 ? 'pnl-pos' : 'pnl-neg'; }

  async function loadPositions(){
    const res = await fetch('/paper/positions', {cache: 'no-store'});
    const data = await res.json();
    const body = document.getElementById('posBody');
    body.innerHTML = '';

    const open = (data && data.open) ? data.open : {};

    const keys = Object.keys(open);
    if (keys.length === 0){
      body.innerHTML = `<tr><td class="muted" colspan="15">Açık pozisyon yok.</td></tr>`;
      return;
    }

    for (const sym of keys){
      const p = open[sym] || {};
      const sideCls = p.side === 'long' ? 'side-long' : 'side-short';

      // USD karşılıkları
      const entryUsd = (p.notional_usd != null) ? p.notional_usd : (p.qty && p.entry ? p.qty * p.entry : null);
      const tpUsd    = (p.tp && p.qty) ? (p.side === 'long' ? (p.tp - p.entry) : (p.entry - p.tp)) * p.qty + entryUsd : null;
      const slUsd    = (p.sl && p.qty) ? (p.side === 'long' ? (p.sl - p.entry) : (p.entry - p.sl)) * p.qty + entryUsd : null;

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="pair">${sym}</td>
        <td class="${sideCls}">${p.side || '-'}</td>
        <td class="num">${fmtQty(p.qty)}</td>
        <td class="num">${fmt4(p.entry)}</td>
        <td class="num">${fmt4(p.tp)}</td>
        <td class="num">${fmt4(p.stop)}</td>
        <td class="num">${fmt2(entryUsd)}</td>
        <td class="num">${fmt2(tpUsd)}</td>
        <td class="num">${fmt2(slUsd)}</td>
        <td class="num ${clsPnl(p.pnl)}">${fmt2(p.pnl)}</td>
        <td class="num">${p.leverage ?? 1}</td>
        <td class="num">${fmt2(p.margin_usd)}</td>
        <td class="num">${fmt2(p.notional_usd)}</td>
        <td class="num">${fmt4(p.liq_price)}</td>
        <td class="num">${fmtDate(p.open_ts)}</td>
      `;
      body.appendChild(tr);
    }
  }

  // ilk yükleme ve periyodik güncelleme
  loadPositions();
  setInterval(loadPositions, 2000);
</script>
</body>
</html>
